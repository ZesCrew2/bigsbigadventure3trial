var HAPITextImage=function(t,i,s,e){this.sprite=[],this.font="undefined"==typeof s?{name:"rodin",size:32,weight:400,color:"0xFFFFFF"}:s,this._order=1,this.alpha=1,this.string=t,this.stringBackup="",this.position={x:0,y:0},this.wibble=new HAPIPair(-2,2).start(1e3,MODE.HAPIPair.DURATION,MODE.HAPIPair.LOOP),this.limitPos=!1,this.markers=[],this.parentStage=e;for(var r=0;i>r;r++)this.sprite.push(new PIXI.Sprite),this.sprite[r]._order=this._order,this.sprite[r].alpha=0,"undefined"==typeof this.parentStage?0==stage.checkChild(this.sprite[r])&&stage.addChild(this.sprite[r]):0==this.parentStage.checkChild(this.sprite[r])&&this.parentStage.addChild(this.sprite[r]),this.sprite[r].used=!1};HAPITextImage.filterStyle=function(t){t=t.split(/{([^}]+)}/g);for(var i=1;i<t.length;i+=2)t[i]="";return t.join("")},HAPITextImage.prototype={constructor:HAPITextImage,destructor:function(){for(var t=0;t<this.sprite.length;t++)"undefined"==typeof this.parentStage?1==stage.checkChild(this.sprite[t])&&stage.removeChild(this.sprite[t]):1==this.parentStage.checkChild(this.sprite[t])&&this.parentStage.removeChild(this.sprite[t])},width:function(){for(var t={min:99999,max:-99999},i=0;i<this.sprite.length;i++)this.sprite[i].used!==!1&&(t.min>this.sprite[i].position.x&&(t.min=this.sprite[i].position.x),t.max<this.sprite[i].position.x+this.sprite[i].width&&(t.max=this.sprite[i].position.x+this.sprite[i].width));return t.max-t.min},height:function(){for(var t={min:99999,max:-99999},i=0;i<this.sprite.length;i++)this.sprite[i].used!==!1&&(t.min>this.sprite[i].position.y&&(t.min=this.sprite[i].position.y),t.max<this.sprite[i].position.y+this.sprite[i].height&&(t.max=this.sprite[i].position.y+this.sprite[i].height));return t.max-t.min},clear:function(){},logic:function(){if("function"==typeof this.additional_logic&&this.additional_logic(),this.wibble.logic(),this.string!=this.stringBackup){for(var t=(HAPITextImage.filterStyle(this.string),0);t<this.sprite.length;t++)this.sprite[t].used=!1,this.sprite[t].texture=loader.fonts[this.font.name].char("\x00",this.font.weight,this.font.size),this.sprite[t].__texture=void 0;return void(this.stringBackup=this.string)}for(var t=0;t<this.sprite.length;t++)this.sprite[t]._order=this._order;this.markers=[];for(var t=0,i=0,s=!1,e="",r=this.font,h=this.position.x,n=this.position.y,o=0,p=!1;t<this.string.length;t++)if(("\\{"==this.string.substr(t,2)||"\\}"==this.string.substr(t,2))&&(t++,p=!0),"{"==this.string.substr(t,1)&&0==p)e="",s=!s;else if("}"==this.string.substr(t,1)&&0==p)"default"==e?r=this.font:(e=JSON.parse("{"+e+"}"),"undefined"==typeof e.name&&(e.name=r.name),"undefined"==typeof e.size&&(e.size=r.size),"undefined"==typeof e.weight&&(e.weight=r.weight),"undefined"==typeof e.color&&(e.color=r.color),"undefined"!=typeof e.setpos&&(h=e.setpos),r=e),s=!s;else if(p=!1,0==s)if("►"==this.string.substr(t,1)&&this.markers.push({x:h,y:n,size:r.size,color:r.color}),"\n"==this.string.substr(t,1))h=this.position.x,n+=1.25*r.size;else{if("¶"==this.string.substr(t,1)){this.limitPos!==!1&&o++;continue}("undefined"==typeof this.sprite[i].__texture||this.sprite[i].__texture!=JSON.stringify({"char":this.string.substr(t,1),font:r}))&&(this.sprite[i].texture=loader.fonts[r.name].char(this.string.substr(t,1),r.weight,r.size),this.sprite[i].tint=r.color,this.sprite[i].scale={x:loader.fonts[r.name].getScale(r.weight,r.size),y:loader.fonts[r.name].getScale(r.weight,r.size)},this.sprite[i].__texture=JSON.stringify({"char":this.string.substr(t,1),font:r})),this.sprite[i].position={x:Math.ceil(h),y:Math.ceil(n)},"undefined"!=typeof r.offset&&(this.sprite[i].position.y+=r.offset),"wibble"==r.effect?this.sprite[i].position.y+=5*Math.cos(this.wibble.current*Math.PI+i):"judder"==r.effect&&(this.sprite[i].position.x+=3*Math.random()-1.5,this.sprite[i].position.y+=3*Math.random()-1.5),h+=this.sprite[i].width,this.sprite[i].__alpha=this.limitPos===!1?this.alpha:this.limitPos-o>i?this.alpha:0,this.sprite[i].alpha!=this.sprite[i].__alpha*this.alpha&&(this.sprite[i].alpha=this.sprite[i].__alpha*this.alpha),this.sprite[i].used=!0,i++}else e+=this.string.substr(t,1)}};