var HAPITextbox=function(t,e,i,s){var r=this;this.parentStage=i,this.parentObject=s,this.sprite={box:new PIXI.Graphics,text:new HAPITextImage("",512,{name:"rodin",size:32,weight:400,color:"0xFFFFFF"},r.parentStage),mugtext:new HAPITextImage("",64,{name:"rodin",size:24,weight:700,color:"0xFFFFFF"},r.parentStage)},this.sprite.box._order=2,this.sprite.mugtext._order=1,this.sprite.text._order=1,this.redraw=!1,this.opacity=new HAPIPair(0,1),this.height=200,this.time=250,this.timeLoop=0,this.textSpeed=1,this.textSpeedFast=4,this.mugtextOpacity=new HAPIPair(0,1),this.mugtextHeight=40,this.margin=8,this.color=new HAPIColorPair("0xFFFFFF","0xFFFFFF"),this.string="undefined"!=typeof e?e:"",this.stringOpacity=new HAPIPair(1,0),this.current=new HAPIPair(0,this.string.length),MODE.add("HAPITextbox",["NULL","INIT","COLORCHANGE","EXIT","MUGTEXTINIT","MUGTEXTEXIT","TEXTFLOW","TEXTWAIT","TEXTCHOICE","TEXTFADE","CHOICELAYOUT"]),this.mode=MODE.HAPITextbox.NULL,this.modeAfter=MODE.HAPITextbox.TEXTWAIT,this.choiceCurrent={x:0,y:0},this.choiceLayout=[],this.finished=!1,this.mugtextMode=MODE.HAPITextbox.NULL,this.mugtextFinished=!1,this.mugtextSide=DIRECTION.LEFT,this.mugtextString="undefined"!=typeof t?t:"",this.mugtextCurrent=new HAPIPair(0,this.mugtextString.length),this.nextIndicator=new HAPIPair(0,1),this.justSet=!1,this.textMarker=0};HAPITextbox.prototype={constructor:HAPITextbox,destructor:function(){this.sprite.text.destructor(),this.sprite.mugtext.destructor(),"undefined"==typeof this.parentStage?1==stage.checkChild(this.sprite.box)&&stage.removeChild(this.sprite.box):1==this.parentStage.checkChild(this.sprite.box)&&this.parentStage.removeChild(this.sprite.box)},draw:function(){if(this.sprite.box.clear(),this.opacity.current>0&&(this.sprite.box.beginFill(this.color.getColor(),this.opacity.current/2),this.sprite.box.lineStyle(2,this.color.getColor(),this.opacity.current),this.sprite.box.drawRect(this.margin,720-this.margin-this.height/2-this.height*this.opacity.current/2,1280-2*this.margin,this.height*this.opacity.current),this.sprite.box.beginFill(this.color.getColor(),this.mugtextOpacity.current),this.sprite.box.lineStyle(2,this.color.getColor(),this.mugtextOpacity.current),this.sprite.box.drawPolygon([this.mugtextSide==DIRECTION.LEFT?this.margin:1280-this.margin,720-this.margin-this.height/2-this.opacity.current*this.height/2-this.mugtextOpacity.current*this.mugtextHeight/2,this.mugtextSide==DIRECTION.LEFT?this.margin+400:1280-(this.margin+400),720-this.margin-this.height/2-this.opacity.current*this.height/2-this.mugtextOpacity.current*this.mugtextHeight/2,this.mugtextSide==DIRECTION.LEFT?this.margin+400+this.mugtextOpacity.current*this.mugtextHeight:1280-(this.margin+400+this.mugtextOpacity.current*this.mugtextHeight),720-this.margin-this.height/2-this.opacity.current*this.height/2+this.mugtextOpacity.current*this.mugtextHeight/2,this.mugtextSide==DIRECTION.LEFT?this.margin:1280-this.margin,720-this.margin-this.height/2-this.opacity.current*this.height/2+this.mugtextOpacity.current*this.mugtextHeight/2]),this.mode==MODE.HAPITextbox.TEXTWAIT&&(this.sprite.box.beginFill("0xFFFFFF",this.nextIndicator.current),this.sprite.box.lineStyle(0),this.sprite.box.drawPolygon([1280-3*this.margin-24,720-3*this.margin-12,1280-3*this.margin,720-3*this.margin-12,1280-3*this.margin-12,720-3*this.margin])),this.mode==MODE.HAPITextbox.TEXTCHOICE))for(var t=0;t<this.sprite.text.markers.length;t++)this.sprite.box.lineStyle(0),this.sprite.box.beginFill("0xFFFFFF",t==this.textMarker?1:.25),this.sprite.box.drawPolygon([this.sprite.text.markers[t].x-this.sprite.text.markers[t].size/2,this.sprite.text.markers[t].y+this.sprite.text.markers[t].size/4+6,this.sprite.text.markers[t].x,this.sprite.text.markers[t].y+this.sprite.text.markers[t].size/2+6,this.sprite.text.markers[t].x-this.sprite.text.markers[t].size/2,this.sprite.text.markers[t].y+this.sprite.text.markers[t].size/4*3+6])},set:function(t,e,i){var s=this;if("undefined"==typeof t)return!1;switch(t){case MODE.HAPITextbox.INIT:this.opacity.set(0,1).set(function(){s.redraw=!0}).start(this.time,MODE.HAPIPair.DURATION),this.mode=t,this.finished=!1,this.nextIndicator.set(0,0).stop();break;case MODE.HAPITextbox.COLORCHANGE:this.color.set(this.color.getColor(),e).set(function(){s.redraw=!0}).start(this.time,MODE.HAPIPair.DURATION),this.mode=t,this.finished=!1,this.nextIndicator.set(0,0).stop();break;case MODE.HAPITextbox.EXIT:this.opacity.set(1,0).set(function(){s.redraw=!0}).start(this.time,MODE.HAPIPair.DURATION),this.mode=t,this.finished=!1,this.nextIndicator.set(0,0).stop();break;case MODE.HAPITextbox.MUGTEXTINIT:"string"==typeof e&&(this.mugtextString=e),this.sprite.mugtext.string="",this.mugtextCurrent.set(0,HAPITextImage.filterStyle(this.mugtextString).length),this.mugtextOpacity.set(0,1).set(function(){s.redraw=!0}).start(this.time,MODE.HAPIPair.DURATION),this.mugtextMode=t,this.mugtextFinished=!1,this.nextIndicator.set(0,0).stop();break;case MODE.HAPITextbox.MUGTEXTEXIT:this.mugtextCurrent.set(HAPITextImage.filterStyle(this.mugtextString).length,0).start(this.textSpeed),this.mugtextMode=t,this.mugtextFinished=!1,this.nextIndicator.set(0,0).stop();break;case MODE.HAPITextbox.TEXTFLOW:"string"==typeof e&&(this.string=e),this.sprite.text.clear(),this.current.set("object"==typeof i&&"boolean"==typeof i.immediate&&i.immediate===!0?HAPITextImage.filterStyle(this.string).length:0,HAPITextImage.filterStyle(this.string).length).start(this.textSpeed),this.mode=t,this.finished=!1,this.nextIndicator.set(0,0).stop(),this.stringOpacity.set(1,1),this.modeAfter="object"==typeof i&&"undefined"!=typeof i.modeAfter?i.modeAfter:MODE.HAPITextbox.TEXTWAIT,this.choiceLayout="object"==typeof i&&"undefined"!=typeof i.choiceLayout?i.choiceLayout:[];break;case MODE.HAPITextbox.TEXTWAIT:this.mode=t,this.finished=!1,this.nextIndicator.set(0,1).set(function(){s.redraw=!0}).start(this.time,MODE.HAPIPair.DURATION,MODE.HAPIPair.OSCILLATE);break;case MODE.HAPITextbox.TEXTCHOICE:this.mode=t,this.textMarker=0,this.finished=!1,this.nextIndicator.set(0,0).stop();break;case MODE.HAPITextbox.CHOICELAYOUT:for(;this.choiceLayout.length<i[0]+1;)this.choiceLayout.push({});return void(this.choiceLayout[i[0]][e]=i[1]);case MODE.HAPITextbox.TEXTFADE:this.mode=t,this.finished=!1,this.stringOpacity.set(1,0).set(function(){s.redraw=!0}).start(this.time,MODE.HAPIPair.DURATION),this.nextIndicator.set(0,0).stop()}s.redraw=!0,this.justSet=!0},logic:function(){if(1==this.justSet)return void(this.justSet=!1);var t=this;if(0==this.timeLoop&&this.time<0&&(this.timeLoop=this.time),"undefined"==typeof this.parentStage?0==stage.checkChild(this.sprite.box)&&stage.addChild(this.sprite.box):0==this.parentStage.checkChild(this.sprite.box)&&this.parentStage.addChild(this.sprite.box),this.sprite.text.position={x:3*this.margin,y:720-this.margin-this.height+3*this.margin+4},this.sprite.mugtext.position={x:this.mugtextSide==DIRECTION.LEFT?3*this.margin:1280-this.sprite.mugtext.width()-3*this.margin,y:720-this.margin-this.height-16},0==this.finished)switch(this.mode){case MODE.HAPITextbox.INIT:case MODE.HAPITextbox.EXIT:1==this.opacity.logic()&&(this.finished=!0);break;case MODE.HAPITextbox.COLORCHANGE:1==this.color.logic()&&(this.finished=!0);break;case MODE.HAPITextbox.TEXTFLOW:this.current.incFrame=1==CONTROLS.btnA.held?this.textSpeedFast:this.textSpeed,(1==CONTROLS.start.pressed||1==this.time)&&(this.current.current=this.current.end),1==this.current.finished()&&this.set(this.modeAfter);break;case MODE.HAPITextbox.TEXTWAIT:1==CONTROLS.btnA.pressed&&(this.finished=!0),1==CONTROLS.btnB.pressed&&(this.finished=!0),1==CONTROLS.btnC.pressed&&(this.finished=!0),1==CONTROLS.start.pressed&&(this.finished=!0);break;case MODE.HAPITextbox.TEXTCHOICE:1==CONTROLS.up.pressed&&("object"==typeof this.choiceLayout[this.textMarker]&&"undefined"!=typeof this.choiceLayout[this.textMarker].up?this.textMarker=this.choiceLayout[this.textMarker].up:this.textMarker--,this.textMarker<0&&(this.textMarker=0),this.redraw=!0),1==CONTROLS.down.pressed&&("object"==typeof this.choiceLayout[this.textMarker]&&"undefined"!=typeof this.choiceLayout[this.textMarker].down?this.textMarker=this.choiceLayout[this.textMarker].down:this.textMarker++,this.textMarker>this.sprite.text.markers.length-1&&(this.textMarker=this.sprite.text.markers.length-1),this.redraw=!0),1==CONTROLS.left.pressed&&("object"==typeof this.choiceLayout[this.textMarker]&&"undefined"!=typeof this.choiceLayout[this.textMarker].left?this.textMarker=this.choiceLayout[this.textMarker].left:this.textMarker--,this.textMarker<0&&(this.textMarker=0),this.redraw=!0),1==CONTROLS.right.pressed&&("object"==typeof this.choiceLayout[this.textMarker]&&"undefined"!=typeof this.choiceLayout[this.textMarker].right?this.textMarker=this.choiceLayout[this.textMarker].right:this.textMarker++,this.textMarker>this.sprite.text.markers.length-1&&(this.textMarker=this.sprite.text.markers.length-1),this.redraw=!0),1==CONTROLS.btnA.pressed&&(this.finished=!0),1==CONTROLS.btnB.pressed&&(this.finished=!0),1==CONTROLS.btnC.pressed&&(this.finished=!0),1==CONTROLS.start.pressed&&(this.finished=!0);break;case MODE.HAPITextbox.TEXTFADE:1==this.stringOpacity.logic()&&(this.finished=!0)}if(0==this.mugtextFinished)switch(this.mugtextMode){case MODE.HAPITextbox.MUGTEXTINIT:this.mugtextCurrent.incFrame=1==CONTROLS.btnA.held?this.textSpeedFast:this.textSpeed,(1==CONTROLS.start.pressed||1==this.time)&&(this.mugtextCurrent.current=this.mugtextCurrent.end),1==this.mugtextOpacity.logic()&&this.mugtextCurrent.set(0,HAPITextImage.filterStyle(this.mugtextString).length).start(this.textSpeed),1==this.mugtextCurrent.logic()&&(this.mugtextFinished=!0);break;case MODE.HAPITextbox.MUGTEXTEXIT:this.mugtextCurrent.incFrame=1==CONTROLS.btnA.held?this.textSpeedFast:this.textSpeed,(1==CONTROLS.start.pressed||1==this.time)&&(this.mugtextCurrent.current=this.mugtextCurrent.end),1==this.mugtextCurrent.logic()&&this.mugtextOpacity.set(1,0).set(function(){t.redraw=!0}).start(this.time,MODE.HAPIPair.DURATION),1==this.mugtextOpacity.logic()&&(this.mugtextFinished=!0)}return this.color.logic(),this.current.logic(),this.nextIndicator.logic(),this.sprite.text.logic(),this.sprite.mugtext.logic(),this.sprite.text.limitPos=parseInt(this.current.current),this.sprite.text.string=this.string,this.sprite.text.alpha=this.stringOpacity.current,this.sprite.mugtext.limitPos=parseInt(this.mugtextCurrent.current),this.sprite.mugtext.string=this.mugtextString,++this.timeLoop<0?this.logic():void(1==this.redraw&&(this.draw(),this.redraw=!1))}};