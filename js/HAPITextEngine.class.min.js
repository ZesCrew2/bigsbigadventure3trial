var HAPITextEngine=function(){var e=this;this.stage=new PIXI.Container,this.sprite={textbox:new HAPITextbox("","",e.stage,e),textcentre:new HAPITextCentreImage("",512,{name:"rodin",size:32,weight:500,color:"0xFFFFFF"},void 0,e.stage),mugshot:[],bgimage:{},bg:new PIXI.Graphics,fg:new PIXI.Graphics},HAPIOverlay.bind(this.sprite.bg,"0x000000",0),HAPIOverlay.bind(this.sprite.fg,"0x000000",0),this.sprite.bg._order=1e6,this.sprite.fg._order=-98,this.stage.addChild(this.sprite.bg),this.stage.addChild(this.sprite.fg),this.queue=[],this.queueWait=!1,this.queueWaitLogic=function(){}};HAPITextEngine.prototype={constructor:HAPITextEngine,destructor:function(){this.sprite.textcentre.destructor(),this.sprite.textbox.destructor();for(var e=0;e<this.sprite.mugshot.length;e++)this.sprite.mugshot[e].destructor();1==stage.checkChild(this.stage)&&stage.removeChild(this.stage)},logic:function(){0==stage.checkChild(this.stage)&&stage.addChild(this.stage),this.sprite.bg.logic(),this.sprite.fg.logic();for(var e in this.sprite.bgimage)"undefined"!=typeof this.sprite.bgimage[e]&&"undefined"!=typeof this.sprite.bgimage[e].logic&&this.sprite.bgimage[e].logic();this.sprite.textcentre.logic(),this.sprite.textbox.logic();for(var e=0;e<this.sprite.mugshot.length;e++)this.sprite.mugshot[e].logic();0==this.queueWait&&this.queue.length>0?(this.queueRun(this.queue.shift()),this.queueWait=!0):1==this.queueWait&&this.queueWaitLogic()},mugshotAdd:function(e,t){return this.sprite.mugshot.push(new HAPIMugshot(this.stage)),this.sprite.mugshot[this.sprite.mugshot.length-1].setMug(e,t),this.sprite.mugshot[this.sprite.mugshot.length-1].order(this.sprite.mugshot.length-1),this},mugshotRemove:function(e){return"undefined"==typeof e?this.sprite.mugshot.pop():this.sprite.mugshot.slice(e,1),this},queueAdd:function(e){return this.queue.push(e),this},queueAddMulti:function(e){for(var t=0;t<e.length;t++)this.queue.push(e[t]);return this},queueRun:function(e){e.init(),"function"!=typeof e.wait?(this.queueWaitLogic=e.wait.func,this.queueWaitWhich="undefined"!=typeof e.wait.which?e.wait.which:void 0,this.queueWaitLine="undefined"!=typeof e.wait.line?e.wait.line:void 0):this.queueWaitLogic=e.wait},scripts:{},mugIndexes:{},mugIndex:0,scriptClean:function(){this.scripts={}},scriptDecode:function(e,t){var s=this;"undefined"==typeof t&&this.scriptClean(),e=e.replace(/\r/g,"").split("\n");for(var i,r,c,n,o=0,p=!1,u=0;u<e.length;u++)if(r=e[u],"//"!=r.substring(0,2))if("/*"!=r.substring(0,2))if("*/"!=r.substring(0,2)){if(1!=p)if(0!=r.indexOf("[")||r.indexOf("]")!=r.length-1)switch(r=r.split(" "),c=r.shift()){case"":s.scripts[i][++o]={args:{},code:[],check:[],after:[]};break;case"config":s.scripts[i][o].args["code"+s.scripts[i][o].code.length]=r,s.scripts[i][o].code.push(function(e){for(var t=0;t<e.length;t++)if(e[t]=e[t].split(":"),s.sprite.textbox[e[t][0]]=isNaN(parseFloat(e[t][1]))?e[t][1]:parseFloat(e[t][1]),"time"==e[t][0])for(var i=0;i<s.sprite.mugshot.length;i++)s.sprite.mugshot[i].time=1==parseFloat(e[t][1])?1:2*parseFloat(e[t][1])});break;case"addmug":s.scripts[i][o].args["code"+s.scripts[i][o].code.length]=r,s.scripts[i][o].code.push(function(e){s.mugshotAdd(e[0],"undefined"==typeof e[1]?0:parseInt(e[1])),s.mugIndexes[e[0]]=s.mugIndex++});break;case"removemug":s.scripts[i][o].args["code"+s.scripts[i][o].code.length]=r,s.scripts[i][o].code.push(function(e){s.mugshotRemove(s.mugIndexes[e[0]]);for(var t in s.mugIndexes)s.mugIndexes[t]>s.mugIndexes[e[0]]&&s.mugIndexes[t]--;s.mugIndexes[e[0]]=void 0});break;case"setcolor":"undefined"==typeof r[1]?(s.scripts[i][o].args["code"+s.scripts[i][o].code.length]=r,s.scripts[i][o].code.push(function(e){s.sprite.textbox.set(MODE.HAPITextbox.COLORCHANGE,e[0])}),s.scripts[i][o].check.push(function(){return s.sprite.textbox.mode==MODE.HAPITextbox.COLORCHANGE&&1==s.sprite.textbox.finished})):(s.scripts[i][o].args["code"+s.scripts[i][o].code.length]=r,s.scripts[i][o].code.push(function(e){s.sprite.textbox.color.set(e[0],e[1])}));break;case"setmugtextside":s.scripts[i][o].args["code"+s.scripts[i][o].code.length]=r,s.scripts[i][o].code.push(function(e){s.sprite.textbox.mugtextSide=DIRECTION[e[0]]});break;case"open":s.scripts[i][o].args["code"+s.scripts[i][o].code.length]=r,s.scripts[i][o].code.push(function(){s.sprite.textbox.set(MODE.HAPITextbox.INIT)}),s.scripts[i][o].check.push(function(){return s.sprite.textbox.mode==MODE.HAPITextbox.INIT&&1==s.sprite.textbox.finished});break;case"close":s.scripts[i][o].args["code"+s.scripts[i][o].code.length]=r,s.scripts[i][o].code.push(function(){s.sprite.textbox.set(MODE.HAPITextbox.EXIT)}),s.scripts[i][o].check.push(function(){return s.sprite.textbox.mode==MODE.HAPITextbox.EXIT&&1==s.sprite.textbox.finished});break;case"mug":isNaN(r[1])?(s.scripts[i][o].args["code"+s.scripts[i][o].code.length]=r,s.scripts[i][o].code.push(function(e){for(var t=e[0],i=[],r=1;r<e.length;r++)i.push(MODE.HAPIMugshot[e[r]]);i.push(MODE.HAPIMugshot.ACTIVE),s.sprite.mugshot[s.mugIndexes[t]].set(i)}),s.scripts[i][o].args["check"+s.scripts[i][o].check.length]=r,s.scripts[i][o].check.push(function(e){var t=e[0];return 1==s.sprite.mugshot[s.mugIndexes[t]].finished})):(s.scripts[i][o].args["code"+s.scripts[i][o].code.length]=r,s.scripts[i][o].code.push(function(e){var t=e[0];s.sprite.mugshot[s.mugIndexes[t]].setFrame(e[1])}));break;case"mugtext":"undefined"==typeof r[0]||""==r[0]?(s.scripts[i][o].args["code"+s.scripts[i][o].code.length]=r,s.scripts[i][o].code.push(function(){s.sprite.textbox.set(MODE.HAPITextbox.MUGTEXTEXIT)}),s.scripts[i][o].check.push(function(){return s.sprite.textbox.mugtextMode==MODE.HAPITextbox.MUGTEXTEXIT&&1==s.sprite.textbox.mugtextFinished})):(s.scripts[i][o].args["code"+s.scripts[i][o].code.length]=r,s.scripts[i][o].code.push(function(e){s.sprite.textbox.set(MODE.HAPITextbox.MUGTEXTINIT,e.join(" "))}),s.scripts[i][o].check.push(function(){return s.sprite.textbox.mugtextMode==MODE.HAPITextbox.MUGTEXTINIT&&1==s.sprite.textbox.mugtextFinished}));break;case"text":"undefined"==typeof r[0]||""==r[0]?(s.scripts[i][o].args["code"+s.scripts[i][o].code.length]=r,s.scripts[i][o].code.push(function(){s.sprite.textbox.set(MODE.HAPITextbox.TEXTFADE)}),s.scripts[i][o].check.push(function(){return s.sprite.textbox.mode==MODE.HAPITextbox.TEXTFADE&&1==s.sprite.textbox.finished}),s.scripts[i][o].after.push(function(){s.sprite.textbox.string=""})):(s.scripts[i][o].args["code"+s.scripts[i][o].code.length]=r,s.scripts[i][o].code.push(function(e){s.sprite.textbox.set(MODE.HAPITextbox.TEXTFLOW,e.join(" ").replace(/\\n/g,"\n"))}),s.scripts[i][o].check.push(function(){return s.sprite.textbox.mode!=MODE.HAPITextbox.TEXTFLOW&&1==s.sprite.textbox.finished}));break;case"choice":if(n=r[0],isNaN(n))switch(n){case"text":s.scripts[i][o].args["code"+s.scripts[i][o].code.length]=r,s.scripts[i][o].code.push(function(e){e.shift(),s.sprite.textbox.set(MODE.HAPITextbox.TEXTFLOW,e.join(" ").replace(/\\n/g,"\n"),{modeAfter:MODE.HAPITextbox.TEXTCHOICE})}),s.scripts[i][o].check.push(function(){return s.sprite.textbox.mode!=MODE.HAPITextbox.TEXTFLOW&&1==s.sprite.textbox.finished})}else r.length>=3&&(s.scripts[i][o].args["code"+s.scripts[i][o].code.length]=r,s.scripts[i][o].code.push(function(e){"undefined"!=typeof e[2]&&s.sprite.textbox.set(MODE.HAPITextbox.CHOICELAYOUT,"up",[parseInt(e[0]),parseInt(e[2])]),"undefined"!=typeof e[3]&&s.sprite.textbox.set(MODE.HAPITextbox.CHOICELAYOUT,"down",[parseInt(e[0]),parseInt(e[3])]),"undefined"!=typeof e[4]&&s.sprite.textbox.set(MODE.HAPITextbox.CHOICELAYOUT,"left",[parseInt(e[0]),parseInt(e[4])]),"undefined"!=typeof e[5]&&s.sprite.textbox.set(MODE.HAPITextbox.CHOICELAYOUT,"right",[parseInt(e[0]),parseInt(e[5])])})),s.scripts[i][o].args["after"+s.scripts[i][o].after.length]=r,s.scripts[i][o].after.push(function(e){return s.sprite.textbox.textMarker==parseInt(e[0])?s.scriptRun(e[1]):void 0});break;case"middletext":"undefined"==typeof r[0]||""==r[0]?(s.scripts[i][o].code.push(function(){s.sprite.textcentre.opacity.set(1,0).start(s.sprite.textbox.time,MODE.HAPIPair.DURATION)}),s.scripts[i][o].check.push(function(){return 0==s.sprite.textcentre.opacity.current})):"settimeout"==r[0]?(s.scripts[i][o].args["code"+s.scripts[i][o].code.length]=r,s.scripts[i][o].code.push(function(e){s.sprite.textcentre._timeout=parseInt(e[1])})):(s.scripts[i][o].args["code"+s.scripts[i][o].code.length]=r,s.scripts[i][o].code.push(function(e){s.sprite.textcentre.opacity.current>0?(s.sprite.textcentre._tempstring=e.join(" ").replace(/\\n/g,"\n"),s.sprite.textcentre.opacity.set(1,0).start(s.sprite.textbox.time,MODE.HAPIPair.DURATION),setTimeout(function(){s.sprite.textcentre.string=s.sprite.textcentre._tempstring+"",s.sprite.textcentre._tempstring=void 0,s.sprite.textcentre.opacity.set(0,1).start(s.sprite.textbox.time,MODE.HAPIPair.DURATION)},s.sprite.textbox.time)):(s.sprite.textcentre.string=e.join(" ").replace(/\\n/g,"\n"),s.sprite.textcentre.opacity.set(0,1).start(s.sprite.textbox.time,MODE.HAPIPair.DURATION))}),s.scripts[i][o].args["check"+s.scripts[i][o].code.length]=r,s.scripts[i][o].check.push(function(){return 1==s.sprite.textcentre.finished}));break;case"bg":s.scripts[i][o].args["code"+s.scripts[i][o].code.length]=r,s.scripts[i][o].code.push(function(e){null!==/0x[0-9a-fA-F]{6}/.exec(e[0])?s.sprite.bg.set(e[0],parseFloat(e[1]),"undefined"==typeof e[2]?s.sprite.textbox.time:parseInt(e[2])):("undefined"==typeof s.sprite.bgimage[e[0]]&&(s.sprite.bgimage[e[0]]=loader.backgrounds[e[0]],s.sprite.bgimage[e[0]].setParent(s.stage)),null!==/0x[0-9a-fA-F]{6}/.exec(e[1])?s.sprite.bgimage[e[0]].sprite.tint=e[1]:s.sprite.bgimage[e[0]].setOpacity(parseFloat(e[1]),"undefined"==typeof e[2]?s.sprite.textbox.time:parseInt(e[2])))}),s.scripts[i][o].check.push(function(){return s.sprite.bg._alpha.current==s.sprite.bg._alpha.end&&1==s.sprite.bg._color.finished});break;case"fg":s.scripts[i][o].args["code"+s.scripts[i][o].code.length]=r,s.scripts[i][o].code.push(function(e){s.sprite.fg.set(e[0],parseFloat(e[1]),"undefined"==typeof e[2]?s.sprite.textbox.time:parseInt(e[2])),1==fg._alpha.current&&fg.set("0x000000",0,1)}),s.scripts[i][o].check.push(function(){return s.sprite.fg._alpha.current==s.sprite.fg._alpha.end&&1==s.sprite.fg._color.finished});break;case"scene":s.scripts[i][o].args["code"+s.scripts[i][o].code.length]=r,s.scripts[i][o].code.push(function(e){gameSceneChange=e[0],"textEngine"==e[0]&&"undefined"!=typeof e[1]?textEngineScript=e[1]:"reset"==e[0]&&"undefined"!=typeof e[1]&&(gameSceneChangeReset=e[1],"textEngine"==e[1]&&"undefined"!=typeof e[2]&&(textEngineScript=e[2]))});break;case"save":s.scripts[i][o].args["code"+s.scripts[i][o].code.length]=r,s.scripts[i][o].code.push(function(e){saveDataToVar(e[0])});break;case"timer":s.scripts[i][o].args["code"+s.scripts[i][o].code.length]=r,s.scripts[i][o].code.push(function(e){setTimeout(function(){s.queueWait=!1},parseFloat(e[0]))}),s.scripts[i][o].check.push(function(){return 0==s.queueWait});break;case"music":s.scripts[i][o].args["code"+s.scripts[i][o].code.length]=r,s.scripts[i][o].code.push(function(e){e[0];if("undefined"==typeof e[1])0==musicLibrary.check(e[0],"playing")?musicLibrary.play(e[0],1,1,0,!0):musicLibrary.stop(e[0],"volume",.5);else switch(e[1]){case"play":musicLibrary.play(e[0],"undefined"!=typeof e[2]?parseFloat(e[2]):void 0,"undefined"!=typeof e[3]?parseFloat(e[3]):void 0,"undefined"!=typeof e[4]?parseFloat(e[4]):void 0,"undefined"!=typeof e[5]&&"true"==e[5]?!0:void 0);break;case"stop":musicLibrary.stop(e[0],"undefined"!=typeof e[2]?e[2]:void 0,"undefined"!=typeof e[3]?parseFloat(e[3]):void 0);break;case"pause":musicLibrary.volume(e[0],0,"undefined"!=typeof e[2]?parseFloat(e[2]):.5),setTimeout(function(){musicLibrary.pause(e[0])},"undefined"!=typeof e[2]?1e3*parseFloat(e[2]):500);break;case"resume":musicLibrary.resume(e[0],0),musicLibrary.volume(e[0],1,"undefined"!=typeof e[2]?parseFloat(e[2]):.5)}});break;case"sound":s.scripts[i][o].args["code"+s.scripts[i][o].code.length]=r,s.scripts[i][o].code.push(function(e){e[0];if("undefined"==typeof e[1])0==soundLibrary.check(e[0],"playing")?soundLibrary.play(e[0],1,1,0,!0):soundLibrary.stop(e[0],"volume",.5);else switch(e[1]){case"play":soundLibrary.play(e[0],"undefined"!=typeof e[2]?parseFloat(e[2]):void 0,"undefined"!=typeof e[3]?parseFloat(e[3]):void 0,"undefined"!=typeof e[4]?parseFloat(e[4]):void 0,"undefined"!=typeof e[5]&&"true"==e[5]?!0:void 0);break;case"stop":soundLibrary.stop(e[0],"undefined"!=typeof e[2]?e[2]:void 0,"undefined"!=typeof e[3]?parseFloat(e[3]):void 0);break;case"pause":soundLibrary.volume(e[0],0,"undefined"!=typeof e[2]?parseFloat(e[2]):.5),setTimeout(function(){soundLibrary.pause(e[0])},"undefined"!=typeof e[2]?1e3*parseFloat(e[2]):500);break;case"resume":soundLibrary.resume(e[0],0),soundLibrary.volume(e[0],1,"undefined"!=typeof e[2]?parseFloat(e[2]):.5)}});break;case"goto":s.scripts[i][o].args["code"+s.scripts[i][o].code.length]=r,s.scripts[i][o].code.push(function(e){return s.scriptRun(e[0])});break;case"setvar":s.scripts[i][o].args["code"+s.scripts[i][o].code.length]=r,s.scripts[i][o].code.push(function(e){if("undefined"!=typeof e[0]){var t=e.shift();GLOBAL_VARS[t]=e.join(" ")}});break;case"checkvar":s.scripts[i][o].args["code"+s.scripts[i][o].code.length]=r,s.scripts[i][o].code.push(function(e){if("undefined"!=typeof GLOBAL_VARS[e[0]]&&"undefined"!=typeof e[1]&&"undefined"!=typeof e[2]){var t=e.shift(),i=e.shift(),r=e.join(" ");return GLOBAL_VARS[t]==r?s.scriptRun(i):void 0}})}else i=r.substring(1,r.length-1),"undefined"==typeof s.scripts[i]?(o=0,s.scripts[i]=[]):o=s.scripts[i].length,s.scripts[i][o]={args:{},code:[],check:[],after:[]}}else p=!1;else p=!0;return this},scriptRun:function(e,t,s){var i=this;if("undefined"==typeof i.scripts[e])return!0;if("undefined"==typeof t){for(var r=[],c=0;c<i.scripts[e].length;c++)r.push({which:e,line:c,init:function(){i.scriptRun(this.which,this.line,"init")},wait:{func:function(){i.scriptRun(i.queueWaitWhich,i.queueWaitLine,"wait")},which:e,line:c}});i.queue=[],i.queueAddMulti(r)}else switch(s){case"init":for(var n=0;n<i.scripts[e][t].code.length;n++)args="undefined"==typeof i.scripts[e][t].args["code"+n]?[]:i.scripts[e][t].args["code"+n],i.scripts[e][t].code[n](args);break;case"wait":for(var o,p=!0,n=0;n<i.scripts[e][t].check.length;n++)args="undefined"==typeof i.scripts[e][t].args["check"+n]?[]:i.scripts[e][t].args["check"+n],o=i.scripts[e][t].check[n](args),0==o&&(p=!1);if(1==p){i.queueWait=!1;for(var n=0;n<i.scripts[e][t].after.length;n++)args="undefined"==typeof i.scripts[e][t].args["after"+n]?[]:i.scripts[e][t].args["after"+n],i.scripts[e][t].after[n](args)}}}};